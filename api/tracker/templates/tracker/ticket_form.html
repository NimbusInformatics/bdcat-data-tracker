{% extends "base_generic.html" %} {% load widget_tweaks %} {% block content %}
<h1 class="text-muted" style="text-align: center">Ticket Item</h1>

{% comment %} <button onclick="show_summary()">yes</button>
<button onclick="show_form()">yes</button> {% endcomment %}

<form id="ticket-form" class="needs-validation pb-5 pe-2" method="post">
  <div class="row g-2">
    {% csrf_token %}

    <!-- Hidden fields(?) -->
    {% for hidden_field in form.hidden_fields %} {{ hidden_field }} {% endfor %}

    <!-- Right-side util -->
    <div class="col-md-5 col-lg-4 order-md-last">
      <!-- Handle Errors -->
      {% if form.errors %}
      <h4 class="d-flex justify-content-between align-items-center mb-3">
        <span class="badge bg-danger rounded-pill">{{ form.errors|length }} Error(s)</span>
        <h6 class="text-muted">Please fix the following errors</h6>
      </h4>
      <ul class="list-group mb-3">
        {% for field in form %} {% if field.errors %}
        <li class="list-group-item d-flex justify-content-between lh-sm">
          <h6 class="my-0">{{ field.label }}</h6>
          {% for error in field.errors %}
          <small class="text-muted">{{ error }}</small>
          {% endfor %}
        </li>
        {% endif %} {% endfor %}
      </ul>
      {% endif %}

      <!-- Badge Logic -->
      {% if object is None %}
      <h4 class="d-flex justify-content-between align-items-center mb-3">
        <span class="badge bg-info rounded-pill">Creating Ticket</span>
      </h4>
      {% else %}
      <h4 class="d-flex justify-content-between align-items-center mb-3">
        <span class="badge bg-{{ status.2 }} rounded-pill">{{ status.1 }}</span>
      </h4>

      <!-- Logs -->
      <h6 class="text-muted">Last Update: {{ ticket.get_ticket_status.0 }}</h6>
      <ul class="list-group mb-3">
        <li class="list-group-item d-flex justify-content-between lh-sm">
          <h6 class="my-0">Created Date</h6>
          <small class="text-muted">{{ ticket.created_dt }}</small>
        </li>
        {% if ticket.ticket_approved_dt %}
        <li class="list-group-item flex-column justify-content-between lh-sm">
          <div class="d-flex w-100 justify-content-between">
            <h6 class="my-0">Data Intake Form Accepted Date</h6>
            <small class="text-muted">{{ ticket.ticket_approved_dt }}</small>
          </div>
          {% if ticket.ticket_review_comment %}
          <hr />
          <small class="text-muted text-end"><strong>Reason: </strong>{{ ticket.ticket_review_comment }}</small>
          {% endif %}
        </li>
        {% endif %} {% if ticket.bucket_created_dt %}
        <li class="list-group-item d-flex justify-content-between lh-sm">
          <h6 class="my-0">NHLBI Bucket Created Date</h6>
          <small class="text-muted">{{ ticket.bucket_created_dt }}</small>
        </li>
        {% endif %} {% if ticket.data_uploaded_started_dt %}
        <li class="list-group-item d-flex justify-content-between lh-sm">
          <h6 class="my-0">Data Custodian Upload Started Date</h6>
          <small class="text-muted">{{ ticket.data_uploaded_started_dt }}</small>
        </li>
        {% endif %} {% if ticket.data_uploaded_completed_dt %}
        <li class="list-group-item d-flex justify-content-between lh-sm">
          <h6 class="my-0">Data Upload Completed Date</h6>
          <small class="text-muted">{{ ticket.data_uploaded_completed_dt }}</small>
        </li>
        {% endif %} {% if ticket.data_accepted_dt %}
        <li class="list-group-item d-flex justify-content-between lh-sm">
          <h6 class="my-0">Gen3 Accepted Date</h6>
          <small class="text-muted">{{ ticket.data_accepted_dt }}</small>
        </li>
        {% endif %} {% if ticket.ticket_rejected_dt %}
        <li class="list-group-item flex-column justify-content-between lh-sm">
          <div class="d-flex w-100 justify-content-between">
            <h6 class="my-0">Data Intake Form Rejected Date</h6>
            <small class="text-muted">{{ ticket.ticket_rejected_dt }}</small>
          </div>
          {% if ticket.ticket_review_comment %}
          <hr />
          <small class="text-muted text-end"><strong>Reason: </strong>{{ ticket.ticket_review_comment }}</small>
          {% endif %}
        </li>
        {% endif %} {% endif %}
      </ul>

      <!-- Button Logic -->
      <div class="row my-2 px-5">
        {% if "Awaiting NHLBI Review" in status %}
        <textarea class="form-control mb-2" id="{{ form.ticket_review_comment.auto_id }}"
          name="{{ form.ticket_review_comment.name }}" placeholder="{{ form.ticket_review_comment.help_text }}"
          rows="9">
{{ form.ticket_review_comment.value }}</textarea>
        <input class="btn btn-success btn-md mb-2" type="submit" name="status_update" value="Approve Ticket" />
        <input class="btn btn-danger btn-md" type="submit" name="status_update" value="Reject Ticket" />
        {% endif %} {% if "Awaiting NHLBI Cloud Bucket Creation" in status %}
        <input class="btn btn-success btn-md mb-2" type="submit" name="status_update" value="Mark Bucket Created" />
        {% endif %} {% if "Awaiting Data Custodian Upload Start" in status %}
        <input class="btn btn-success btn-md mb-2" type="submit" name="status_update" value="Mark as Data Uploaded" />
        {% endif %} {% if "Awaiting Data Custodian Upload Complete" in status %}
        <input class="btn btn-success btn-md mb-2" type="submit" name="status_update" value="Mark as Data Uploaded" />
        {% endif %} {% if "Awaiting Gen3 Acceptance" in status %}
        <input class="btn btn-success btn-md mb-2" type="submit" name="status_update" value="Mark as Gen3 Approved" />
        {% endif %} {% if "Data Intake Form Rejected" in status %}
        <input class="btn btn-success btn-md mb-2" type="submit" name="status_update" value="Revive Ticket" />
        {% endif %}
      </div>
      {% if object %}
      <hr />
      <div class="row px-5">
        <button class="btn btn-danger btn-md mb-2" onclick="show_form()">
          Edit Ticket
        </button>
      </div>
      {% endif %}
    </div>

    <!-- Display Form -->
    <div class="col-md-7 col-lg-8 px-3">
      <h4 class="mb-3 form-element">Contact Information</h4>
      <div class="row g-3 form-element">
        <!-- Name and Email -->
        <div class="col-sm-6">
          <label for="{{ form.name.id_for_label }}" class="form-label"><span
              class="required">*</span>{{ form.name.label }}</label>
          <input type="text" class="form-control {% if form.name.errors %}is-invalid{% endif %}"
            id="{{ form.name.auto_id }}" name="{{ form.name.name }}" placeholder="{{ form.name.help_text }}"
            value="{{ form.name.value }}" />
        </div>
        <div class="col-sm-6">
          <label for="{{ form.email.id_for_label }}" class="form-label"><span
              class="required">*</span>{{ form.email.label }}</label>
          <input type="text" class="form-control {% if form.email.errors %}is-invalid{% endif %}"
            id="{{ form.email.auto_id }}" name="{{ form.email.name }}" placeholder="{{ form.email.label }}"
            value="{{ form.email.value }}" />
        </div>

        <!-- Organization -->
        <div class="col-12">
          <label for="{{ form.organization.id_for_label }}" class="form-label"><span
              class="required">*</span>{{ form.organization.label }}</label>
          <input type="text" class="form-control {% if form.organization.errors %}is-invalid{% endif %}"
            id="{{ form.organization.auto_id }}" name="{{ form.organization.name }}"
            placeholder="{{ form.organization.help_text }}" value="{{ form.organization.value }}" />
        </div>

        <hr class="my-4" />
      </div>

      <h4 class="mb-3 form-element">Study Information</h4>
      <div class="row g-3 form-element">
        <!-- Study Name -->
        <div class="col-12">
          <label for="{{ form.study_name.id_for_label }}" class="form-label"><span
              class="required">*</span>{{ form.study_name.label }}</label>
          <input type="text" class="form-control {% if form.study_name.errors %}is-invalid{% endif %}"
            id="{{ form.study_name.auto_id }}" name="{{ form.study_name.name }}"
            placeholder="{{ form.study_name.help_text }}" value="{{ form.study_name.value }}" />
        </div>

        <!-- Study ID and Consent Code -->
        <div class="col-sm-6">
          <label for="{{ form.study_id.id_for_label }}" class="form-label"><span
              class="required">*</span>{{ form.study_id.label }}</label>
          <input type="text" class="form-control {% if form.study_id.errors %}is-invalid{% endif %}"
            id="{{ form.study_id.auto_id }}" name="{{ form.study_id.name }}" placeholder="{{ form.study_id.label }}"
            value="{{ form.study_id.value }}" />
          <div class="form-text">{{ form.study_id.help_text }}</div>
        </div>
        <div class="col-sm-6">
          <label for="{{ form.consent_code.id_for_label }}" class="form-label"><span
              class="required">*</span>{{ form.consent_code.label }}</label>
          <input type="text" class="form-control
              {% if form.consent_code.errors %}is-invalid{% endif %}" id="{{ form.consent_code.auto_id }}"
            name="{{ form.consent_code.name }}" placeholder="{{ form.consent_code.label }}"
            value="{{ form.consent_code.value }}" />
          <div class="form-text">{{ form.consent_code.help_text }}</div>
        </div>
        <hr class="my-4" />
      </div>

      <h4 class="mb-3 form-element">Dataset Information</h4>
      <div class="row g-3 form-element">
        <!-- Dataset Description -->
        <div class="col-12">
          <label for="{{ form.dataset_description.id_for_label }}"
            class="form-label">{{ form.dataset_description.label }}</label>
          <input type="text" class="form-control {% if form.dataset_description.errors %}is-invalid{% endif %}"
            id="{{ form.dataset_description.auto_id }}" name="{{ form.dataset_description.name }}"
            placeholder="{{ form.dataset_description.help_text }}" rows="12">
          {{ form.dataset_description.value }}</textarea>
        </div>

        <!-- GMail and AWS-->
        <div class="col-sm-6">
          <label for="{{ form.google_email.id_for_label }}" class="form-label">{{ form.google_email.label }}</label>
          <input type="text" class="form-control {% if form.google_email.errors %}is-invalid{% endif %}"
            id="{{ form.google_email.auto_id }}" name="{{ form.google_email.name }}"
            placeholder="{{ form.google_email.label }}" value="{{ form.google_email.value }}" />
          <div class="form-text">{{ form.google_email.help_text }}</div>
        </div>
        <div class="col-sm-6">
          <label for="{{ form.aws_iam.id_for_label }}" class="form-label">{{ form.aws_iam.label }}</label>
          <input type="text" class="form-control {% if form.aws_iam.errors %}is-invalid{% endif %}"
            id="{{ form.aws_iam.auto_id }}" name="{{ form.aws_iam.name }}"
            placeholder="arn:aws:iam::123456789012:user/username" value="{{ form.aws_iam.value }}" />
          <div class="form-text">{{ form.aws_iam.help_text }}</div>
        </div>

        <!-- Data Size -->
        <div class="col-sm-12">
          <label for="{{ form.data_size.id_for_label }}" class="form-label"><span
              class="required">*</span>{{ form.data_size.label }}</label>
          <!-- <div class="row"> -->
          <div class="col-sm-3">
            <input type="text" class="form-control {% if form.data_size.errors %}is-invalid{% endif %}"
              id="id_data_size" name="{{ form.data_size.name }}" placeholder="100 GB"
              value="{{ form.data_size.value }}" />
          </div>
          <!-- <div class="col-sm-6">
              <select
                class="form-select"
                id="id_data_size_unit"
                placeholder="Select Unit"
                value="{{ form.data_unit.value }}"
                aria-label="Data Size Unit Select"
              >
                <option selected>Select Unit</option>
                <option value="MB">MB</option>
                <option value="GB">GB</option>
                <option value="TB">TB</option>
                <option value="PB">PB</option>
              </select>
            </div> -->
          <div class="form-text">{{ form.data_size.help_text }}</div>
        </div>

        <!-- Test Data Checkbox -->
        <div class="col-12">
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="{{form.is_test_data.auto_id }}"
              name="{{ form.is_test_data.name }}" {% if form.is_test_data %} checked {% endif %} />
            <label class="form-check-label"
              for="{{ form.is_test_data.id_for_label }}">{{ form.is_test_data.help_text }}</label>
          </div>
        </div>
        <hr class="my-4" />
      </div>

      <!-- Ticket Detail -->
      <div id="ticket-detail">nnn</div>

      <!-- Handle Create/Update Buttons -->
      <div class="row g-3">
        {% if object %}
        <button class="btn btn-primary btn-lg" type="button" onclick="submit_form()">
          Submit Changes
        </button>
        <a href="{% url 'tracker:ticket-delete' pk=object.pk %}" class="btn btn-cancel btn-lg" role="button">Delete
          Ticket</a>
        {% else %}
        <input class="col btn btn-primary btn-lg" type="submit" value="Submit" />
        {% endif %}
      </div>
    </div>
  </div>
</form>

<script>
  function show_summary() {
    $("#ticket-detail").show();
    $(".form-element").hide();
  }

  function show_form() {
    $(".form-element").show();
    $("#ticket-detail").hide();
  }

  function submit_form() {
    $("#id_data_size").val(function () {
      return this.value.toUpperCase();
    });

    $("#ticket-form").submit();
  }

  show_form();
</script>

<!-- DEBUG -->
<!-- {{ form.as_table }} -->
{% endblock %}